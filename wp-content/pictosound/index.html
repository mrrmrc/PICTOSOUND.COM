<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pictosound - Generatore di Musica da Immagini</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- INCLUDI I FILE CSS ESTERNI -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="auth-styles.css">
    <link rel="stylesheet" href="snapshotstyle.css">

    <style>
        /* AGGIUNGI SOLO LO STILE PER FORZARE IL NON-SPECCHIO DELLA CAMERA */
        #cameraFeed {
            transform: none !important;
            -webkit-transform: none !important;
            -moz-transform: none !important;
            -ms-transform: none !important;
            -o-transform: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="options-section">
            <h3>1. Scegli la tua Immagine</h3>
            <div class="input-actions-container">
                <input type="file" id="imageUpload" accept="image/*" title="Carica un file immagine">
                <button id="takePictureButton" class="icon-button" title="Usa la fotocamera">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24"
                        height="24">
                        <path
                            d="M4 4h3l2-2h6l2 2h3v16H4V4zm8 13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0-8c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z" />
                    </svg>
                    Scatta Foto
                </button>
            </div>
            <div id="cameraViewContainer">
                <video id="cameraFeed" autoplay playsinline></video>
                <div class="camera-controls">
                    <button id="captureImageButton">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z" />
                            <path
                                d="M4 4h3l2-2h6l2 2h3v16H4V4zm8 13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5z"
                                opacity=".3" />
                            <path
                                d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h3l2-2h6l2 2h3v16z" />
                        </svg>
                        Scatta!
                    </button>
                    <button id="switchCameraButton" title="Cambia Fotocamera">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px"
                            fill="currentColor">
                            <path d="M0 0h24v24H0V0z" fill="none" />
                            <path
                                d="M20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z" />
                        </svg>
                        Cambia
                    </button>
                    <button id="closeCameraButton">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                        Annulla
                    </button>
                </div>
            </div>
            <div id="imagePreviewContainer">
                <img id="imagePreview" src="#" alt="Anteprima Immagine" style="display:none;">
                <canvas id="detectionCanvas" style="display:none;"></canvas>
            </div>
        </div>

        <div id="mainContentArea">
            <div class="options-section" id="durationSection">
                <h3>2. Durata Musica</h3>
                <div class="radio-duration-group">
                    <div class="radio-duration-item">
                        <input type="radio" id="duration30" name="musicDuration" value="30" checked>
                        <label for="duration30">
                            <span class="duration-value">30s</span>
                            <span class="duration-credit">3 crediti</span>
                        </label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration45" name="musicDuration" value="45">
                        <label for="duration45">
                            <span class="duration-value">45s</span>
                            <span class="duration-credit">6 crediti</span>
                        </label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration60" name="musicDuration" value="60">
                        <label for="duration60">
                            <span class="duration-value">60s</span>
                            <span class="duration-credit">9 crediti</span>
                        </label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration90" name="musicDuration" value="90">
                        <label for="duration90">
                            <span class="duration-value">90s</span>
                            <span class="duration-credit">12 crediti</span>
                        </label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration120" name="musicDuration" value="120">
                        <label for="duration120">
                            <span class="duration-value">120s</span>
                            <span class="duration-credit">18 crediti</span>
                        </label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration180" name="musicDuration" value="180">
                        <label for="duration180">
                            <span class="duration-value">180s</span>
                            <span class="duration-credit">24 crediti</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="options-section" id="trackNameSection">
                <h3>3. Nome Brano <span style="font-weight:normal; font-size:0.8em; color:var(--light-text);"></span>
                </h3>
                <p class="info-text">Dai un titolo alla tua creazione. Verrà usato come nome del file.</p>
                <input type="text" id="trackName" name="trackName" class="text-input"
                    placeholder="Inserisci il nome del tuo brano" maxlength="40">
            </div>

            <div class="options-section" id="descriptiveCuesSection">
                <h3>FAI LE TUE PERSONALIZZAZIONI <span
                        style="font-weight:normal; font-size:0.8em; color:var(--light-text);">(opzionale)</span></h3>
                <p class="info-text">L'IA genererà la musica anche senza selezioni, basandosi sull'immagine. Le tue
                    scelte aiuteranno a guidare l'interpretazione.</p>

                <div class="bpm-slider-container">
                    <label for="bpmSlider">🎵 Tempo (BPM): <span id="bpmValue">120</span></label>
                    <input type="range" id="bpmSlider" name="bpm" min="40" max="200" value="120" step="5">
                </div>

                <div class="cues-mobile-container">
                    <div class="cues-mobile-section">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="moodPills">
                                <div class="cue-header-content">
                                    <span style="font-size: 1.5em;">😊</span>
                                    <div class="cue-title-with-arrow">
                                        <span class="cue-title">Mood</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                </div>
                            </label>
                            <div class="checkbox-pills-group" id="moodPills">
                                <div class="pill">Felice</div>
                                <div class="pill">Triste</div>
                                <div class="pill">Energico</div>
                                <div class="pill">Rilassante</div>
                                <div class="pill">Romantico</div>
                                <div class="pill">Misterioso</div>
                                <div class="pill">Drammatico</div>
                                <div class="pill">Giocoso</div>
                            </div>
                        </div>
                    </div>

                    <div class="cues-mobile-section">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="genrePills">
                                <div class="cue-header-content">
                                    <span style="font-size: 1.5em;">🎵</span>
                                    <div class="cue-title-with-arrow">
                                        <span class="cue-title">Genere</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                </div>
                            </label>
                            <div class="checkbox-pills-group" id="genrePills">
                                <div class="pill">Pop</div>
                                <div class="pill">Rock</div>
                                <div class="pill">Jazz</div>
                                <div class="pill">Classica</div>
                                <div class="pill">Electronic</div>
                                <div class="pill">Ambient</div>
                                <div class="pill">Folk</div>
                                <div class="pill">Hip-Hop</div>
                                <div class="pill">Indie</div>
                                <div class="pill">Blues</div>
                            </div>
                        </div>
                    </div>

                    <div class="cues-mobile-section">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="instrumentPills">
                                <div class="cue-header-content">
                                    <span style="font-size: 1.5em;">🎹</span>
                                    <div class="cue-title-with-arrow">
                                        <span class="cue-title">Strumenti</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                </div>
                            </label>
                            <div class="checkbox-pills-group" id="instrumentPills">
                                <div class="pill">Pianoforte</div>
                                <div class="pill">Chitarra</div>
                                <div class="pill">Violino</div>
                                <div class="pill">Batteria</div>
                                <div class="pill">Sintetizzatore</div>
                                <div class="pill">Archi</div>
                                <div class="pill">Basso</div>
                                <div class="pill">Flauto</div>
                                <div class="pill">Sassofono</div>
                                <div class="pill">Voce</div>
                            </div>
                        </div>
                    </div>

                    <div class="cues-mobile-section">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="rhythmPills">
                                <div class="cue-header-content">
                                    <span style="font-size: 1.5em;">🥁</span>
                                    <div class="cue-title-with-arrow">
                                        <span class="cue-title">Ritmo</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                </div>
                            </label>
                            <div class="checkbox-pills-group" id="rhythmPills">
                                <div class="pill">Lento</div>
                                <div class="pill">Moderato</div>
                                <div class="pill">Veloce</div>
                                <div class="pill">Sincopato</div>
                                <div class="pill">Steady</div>
                                <div class="pill">Variabile</div>
                                <div class="pill">Swing</div>
                                <div class="pill">Ballata</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons-container">
                <button id="generateMusicButton" disabled>Avvia generazione musica <span id="musicSpinner"
                        style="display:none;" class="spinner"></span></button>

                <div id="loginOrRegisterPrompt" style="display: none;">
                    <strong style="font-size: 16px; color: #0056b3;">🔒 Accesso Richiesto</strong>
                    <p style="margin: 8px 0 0;">Per utilizzare Pictosound devi essere registrato.</p>
                    <p style="margin: 8px 0 0;">La registrazione è <strong>gratuita</strong> e ti premia con <strong>6
                            crediti in omaggio</strong>!</p>
                    <div style="margin-top: 15px;">
                        <a href="/login/"
                            style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; margin-right: 10px; font-weight: 600;">Accedi
                            Ora</a>
                        <a href="/registrazione/"
                            style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 600;">Registrati
                            Gratis</a>
                    </div>
                </div>
            </div>

            <div id="dynamicFeedbackArea">
                <div id="status" class="status-message">In attesa del caricamento dei modelli AI...</div>
                <div id="progressAndPlayerContainer">
                    <div id="progressMessage"></div>
                    <div class="progress-bar-container" id="progressBarContainer">
                        <div class="progress-bar-animated" id="progressBarAnimated"></div>
                    </div>
                    <div id="audioPlayerContainer">
                        <h3>Musica Generata</h3>
                        <audio id="audioPlayer" controls src=""></audio>
                        <p id="audioInfo"></p>
                        <div id="downloadButtonsContainer">
                            <a id="downloadAudioLink" href="#" class="download-button" style="display:none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    width="18" height="18">
                                    <path
                                        d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14a6 6 0 0 0 6 6h13a5 5 0 0 0 5-5c0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z" />
                                </svg>
                                Scarica Audio
                            </a>
                            <a id="downloadCompositeImageLink" href="#" class="download-button" style="display:none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    width="18" height="18">
                                    <path d="M5 20h14v-2H5v2zm14-9h-4V3H9v8H5l7 7 7-7z" />
                                </svg>
                                Scarica Img+QR
                            </a>
                            <a id="downloadQrOnlyLink" href="#" class="download-button" style="display:none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    width="18" height="18">
                                    <path
                                        d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h-2v3h-3v2h5v-5zM13 3h2v2h-2V3zm0 16h2v2h-2v-2zm-5-5h2v2H8v-2z" />
                                </svg>
                                Scarica QR
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="aiInsightsSection" class="options-section">
                <h3>COSA VEDE L'AI</h3>
                <p id="aiInterpretationText">L'intelligenza artificiale ha analizzato la tua immagine per coglierne
                    l'essenza e trasformarla in musica. Ecco come ha interpretato gli elementi visivi:</p>

                <div class="ai-processing-simulation" id="aiProcessingSimulation">
                    <p>In attesa di analisi immagine...</p>
                </div>

                <div class="details-accordion-header">
                    <span>Dettagli Tecnici</span>
                    <span class="toggle-icon"></span>
                </div>
                <div id="aiInsightsContent"></div>
            </div>
        </div>
    </div>

    <canvas id="imageCanvas" style="display:none;"></canvas>
    <canvas id="compositeImageCanvas" style="display:none;"></canvas>
    <textarea id="additionalCuesTextarea" style="display:none;"></textarea>

    <!-- CARICA CAMERA HANDLER -->
    <script src="CameraHandler.js"></script>

    <script>
        // INIZIALIZZAZIONE CAMERA HANDLER
        document.addEventListener('DOMContentLoaded', function () {

            // ===== INIZIALIZZA CAMERA HANDLER =====
            const domElements = {
                takePictureButton: document.getElementById('takePictureButton'),
                captureImageButton: document.getElementById('captureImageButton'),
                switchCameraButton: document.getElementById('switchCameraButton'),
                closeCameraButton: document.getElementById('closeCameraButton'),
                cameraViewContainer: document.getElementById('cameraViewContainer'),
                cameraFeed: document.getElementById('cameraFeed')
            };

            const processImage = function (imageDataURL) {
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = imageDataURL;
                imagePreview.style.display = 'block';

                // Abilita il pulsante di generazione musica se necessario
                const generateButton = document.getElementById('generateMusicButton');
                if (generateButton) {
                    generateButton.disabled = false;
                }
            };

            const setStatusMessage = function (message, type) {
                const statusElement = document.getElementById('status');
                if (statusElement && message) {
                    statusElement.textContent = message;
                    statusElement.className = `status-message ${type}`;
                }
            };

            // Inizializza CameraHandler
            if (window.CameraHandler) {
                CameraHandler.init(domElements, processImage, setStatusMessage);
            } else {
                console.error('CameraHandler non trovato!');
            }

            // ===== GESTIONE FILE UPLOAD (rimane qui perché non usa CameraHandler) =====
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');

            if (imageUpload) {
                imageUpload.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            imagePreview.src = e.target.result;
                            imagePreview.style.display = 'block';

                            // Abilita il pulsante di generazione musica
                            const generateButton = document.getElementById('generateMusicButton');
                            if (generateButton) {
                                generateButton.disabled = false;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // ===== GESTIONE BPM SLIDER =====
            const bpmSlider = document.getElementById('bpmSlider');
            const bpmValue = document.getElementById('bpmValue');

            if (bpmSlider && bpmValue) {
                bpmSlider.addEventListener('input', function () {
                    bpmValue.textContent = this.value;
                });
            }

            // ===== GESTIONE ESPANSIONE SEZIONI PERSONALIZZAZIONI =====
            const headers = document.querySelectorAll('.collapsible-cue-header');

            headers.forEach(header => {
                header.addEventListener('click', function () {
                    const container = this.parentElement;
                    const content = container.querySelector('.checkbox-pills-group');
                    const arrow = this.querySelector('.dropdown-arrow');

                    // Toggle stato espansione
                    const isExpanded = content.classList.contains('expanded');

                    if (isExpanded) {
                        content.classList.remove('expanded');
                        container.classList.remove('expanded');
                        arrow.textContent = '▼';
                    } else {
                        content.classList.add('expanded');
                        container.classList.add('expanded');
                        arrow.textContent = '▲';
                    }
                });
            });

            // ===== GESTIONE SELEZIONE PILLS =====
            const pills = document.querySelectorAll('.pill');
            pills.forEach(pill => {
                pill.addEventListener('click', function () {
                    this.classList.toggle('selected');

                    // Opzionale: limite al numero di selezioni per categoria
                    const container = this.parentElement;
                    const selectedPills = container.querySelectorAll('.pill.selected');

                    // Esempio: massimo 3 selezioni per categoria
                    if (selectedPills.length > 3) {
                        const firstSelected = selectedPills[0];
                        firstSelected.classList.remove('selected');
                    }
                });
            });
        });
    </script>
</body>

</html>