<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoSound - Da Immagine a Musica</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF3366;
            --primary-color-rgb: 255, 51, 102;
            --primary-gradient-start: #FF6633;
            --primary-gradient-end: #6633FF;
            --secondary-color: #0033CC;

            --orange-start: #FFA726;
            --orange-end: #FF7043;
            --orange-rgb: 255, 167, 38;

            --accent-color: #06B6D4;
            --accent-color-darker: #0E7490;
            --dark-text: #0A1F44;
            --medium-text: #3A4F66;
            --light-text: #7E8CA0;
            --light-bg: #F5F7FA;
            --card-bg: #FFFFFF;
            --border-color: #D9E2EC;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --cues-section-bg: #fcf6ec;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--light-bg);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6;
        }

        .container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 780px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .logo {
            height: 65px;
            width: auto;
        }

        h1 {
            color: var(--dark-text);
            text-align: center;
            margin-top: 5px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 2em;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        h3 {
            font-size: 1.35em;
            color: var(--dark-text);
            border-bottom: 2px solid;
            border-image-slice: 1;
            border-image-source: linear-gradient(to right, var(--primary-color), var(--accent-color));
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: var(--medium-text);
            margin-bottom: 25px;
            font-size: 1em;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--medium-text);
            font-size: 0.9em;
        }

        .input-actions-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: stretch;
        }

        .input-actions-container input[type="file"],
        .input-actions-container button.icon-button {
            padding: 12px 15px;
            border: 2px dashed var(--accent-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            background-color: #fafcff;
            font-size: 0.9em;
            color: var(--medium-text);
            transition: all 0.2s ease;
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .input-actions-container input[type="file"] {
            line-height: 1.5;
        }

        .input-actions-container button.icon-button {
            background-color: var(--accent-color-darker);
            border-style: solid;
            color: white;
        }

        .input-actions-container button.icon-button svg {
            width: 24px;
            height: 24px;
            margin-bottom: 5px;
            fill: currentColor;
        }


        .input-actions-container input[type="file"]:hover,
        .input-actions-container button.icon-button:hover {
            border-color: var(--primary-color);
            background-color: #fff;
            color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
        }

        .input-actions-container button.icon-button:hover {
            color: white;
            background-color: var(--accent-color);
        }


        #cameraViewContainer {
            display: none;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #f0f2f5;
        }

        #cameraFeed {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            margin: 0 auto 10px;
            display: block;
            border: 1px solid var(--border-color);
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .camera-controls button {
            padding: 10px 15px;
            font-size: 0.9em;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .camera-controls button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .camera-controls button:hover {
            background-color: var(--accent-color-darker);
        }


        #imagePreviewContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background-color: #f0f2f5;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }

        #imagePreview {
            display: block;
            max-width: 100%;
            max-height: 320px;
            border-radius: calc(var(--border-radius) - 1px);
        }

        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            display: none;
        }

        #mainContentArea {
            margin-top: 20px;
        }

        .action-buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        button {
            color: white;
            border: none;
            padding: 14px 22px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        button:hover {
            transform: translateY(-3px) scale(1.02);
        }

        button:active {
            transform: translateY(0px) scale(0.98);
        }

        button:disabled {
            background: linear-gradient(135deg, #c5c9d1, #a8afba);
            box-shadow: none;
            color: #777c85;
            cursor: not-allowed;
            transform: none;
        }

        #generateMusicButton {
            background: linear-gradient(135deg, var(--orange-start), var(--orange-end));
            box-shadow: 0 4px 15px rgba(var(--orange-rgb), 0.3);
            width: auto;
            min-width: 250px;
            color: var(--dark-text);
        }

        #generateMusicButton:hover {
            box-shadow: 0 7px 20px rgba(var(--orange-rgb), 0.4);
        }

        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2.5px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--dark-text);
            animation: spin 0.7s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #dynamicFeedbackArea {
            margin-top: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        #progressAndPlayerContainer {
            padding: 15px;
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            min-height: 65px;
            display: none;
            margin-top: 0;
        }

        #progressMessage {
            color: var(--dark-text);
            font-size: 0.95em;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .progress-bar-container {
            width: 100%;
            margin: 12px auto;
            background-color: #e9edf2;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            display: none;
        }

        .progress-bar-animated {
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color), var(--accent-color));
            background-size: 300% 100%;
            animation: progress-animation 2s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes progress-animation {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        #status {
            padding: 12px 18px;
            background-color: #eef2f7;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--medium-text);
            font-size: 0.9em;
            display: block;
            margin-bottom: 0;
        }

        .status-error {
            background-color: #ffebee !important;
            border-color: #f44336 !important;
            color: #c62828 !important;
        }

        .status-success {
            background-color: #e8f5e9 !important;
            border-color: #4caf50 !important;
            color: #2e7d32 !important;
        }

        .options-section {
            margin-top: 25px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
        }

        #aiInsightsSection {
            padding: 20px;
            background-color: #fdfdff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            display: none;
            margin-top: 20px;
        }

        #aiInterpretationText {
            font-size: 0.95em;
            color: var(--medium-text);
            margin-bottom: 15px;
            text-align: center;
            line-height: 1.5;
        }

        .details-accordion-header {
            font-size: 1.1em;
            color: var(--dark-text);
            background-color: var(--light-bg);
            padding: 10px 15px;
            margin-top: 15px;
            margin-bottom: 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .details-accordion-header:hover {
            background-color: #e9edf2;
        }

        .details-accordion-header .toggle-icon::before {
            content: '►';
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
            display: inline-block;
        }

        .details-accordion-header.open .toggle-icon::before {
            transform: rotate(90deg);
        }

        #aiInsightsContent {
            font-size: 0.9em;
            line-height: 1.65;
            color: var(--medium-text);
            display: none;
            animation: fadeIn 0.3s ease-out;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            background-color: #fff;
        }

        .details-accordion-header.open+#aiInsightsContent {
            display: block;
        }

        .ai-processing-simulation {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.8em;
            color: var(--light-text);
            height: 2.8em;
            overflow: hidden;
            border: 1px dashed var(--border-color);
            padding: 5px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: var(--light-bg);
        }

        #aiInsightsContent ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        #aiInsightsContent ul li {
            padding: 5px 0;
            border-bottom: 1px dashed #e7eaf0;
        }

        .color-swatch-inline {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 6px;
            vertical-align: middle;
            border: 1px solid var(--border-color);
        }

        #finalPromptForAI {
            margin-top: 15px;
            padding: 12px;
            background-color: var(--dark-text);
            color: #f0f0f0;
            border-radius: 8px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.88em;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
        }


        #descriptiveCuesSection {
            background-color: var(--cues-section-bg);
        }

        #descriptiveCuesSection .info-text-cues-main {
            font-size: 0.95em;
            color: var(--medium-text);
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }

        .cues-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .cues-column .cues-selection-container {
            margin-bottom: 0;
        }

        .collapsible-cue-header {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 1.05em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border-color);
            transition: color 0.2s ease;
        }

        .collapsible-cue-header:hover {
            color: var(--primary-color);
        }

        .collapsible-cue-header .cue-header-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cue-icon-small {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
        }

        .toggle-icon-cues::before {
            content: '►';
            font-weight: bold;
            color: var(--medium-text);
            font-size: 0.7em;
            transition: transform 0.2s ease-in-out;
            display: inline-block;
        }

        .collapsible-cue-header.open .toggle-icon-cues::before {
            transform: rotate(90deg);
        }

        .checkbox-pills-group {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        .checkbox-pills-group.open {
            display: flex;
        }

        .checkbox-pill {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.9em;
            background-color: var(--light-bg);
            color: var(--medium-text);
            user-select: none;
        }

        .checkbox-pill input[type="checkbox"] {
            display: none;
        }

        .checkbox-pill:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: #fff;
            transform: translateY(-1px);
        }

        .checkbox-pill.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-gradient-end));
            color: white;
            border-color: transparent;
        }

        .bpm-slider-container {
            margin-top: 15px;
            margin-bottom: 10px;
            display: block;
        }

        .bpm-slider-container.in-mood-section {
            display: none;
        }

        .collapsible-cue-header.open~.bpm-slider-container.in-mood-section {
            display: block;
        }

        .bpm-slider-container label {
            font-weight: 500;
            color: var(--dark-text);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .bpm-slider-container input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        #bpmValue {
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }

        #audioPlayerContainer h3 {
            font-size: 1.1em;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        #audioInfo {
            font-size: 0.85em;
        }

        #downloadButtonsContainer {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .download-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .download-button:hover {
            transform: translateY(-2px);
        }

        .radio-duration-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 0 0 15px 0;
            justify-content: center;
        }

        .radio-duration-item {
            min-width: 85px;
            position: relative;
        }

        .radio-duration-item input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-duration-item label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            transition: all 0.25s ease-in-out;
            border-radius: var(--border-radius);
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            height: 100%;
        }

        .radio-duration-item input[type="radio"]:checked+label {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-gradient-end));
            border-color: transparent;
            color: white;
        }

        .radio-duration-item label .duration-value {
            font-weight: 600;
        }

        .radio-duration-item label .duration-credit {
            font-size: 0.75em;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .cues-grid-container {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo-container">
            <img src="/wp-content/pictosound/icone/logo.png" alt="PictoSound Logo" class="logo"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAyMDAgODAiPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjIiIGZpbGw9IiNjY2MiPkxvZ288L3RleHQ+PC9zdmc+'; this.onerror=null;">
        </div>
        <h1>TRASFORMA L'IMMAGINE IN MUSICA</h1>
        <p class="subtitle">Lascia che l'AI analizzi l'immagine e la trasformi in esperienza sonora. Da oggi anche le
            immagini hanno un suono.</p>

        <div class="options-section">
            <h3>1. Scegli la tua Immagine</h3>
            <div class="input-actions-container">
                <input type="file" id="imageUpload" accept="image/*" title="Carica un file immagine">
                <button id="takePictureButton" class="icon-button" title="Usa la fotocamera">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24"
                        height="24">
                        <path
                            d="M4 4h3l2-2h6l2 2h3v16H4V4zm8 13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0-8c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z" />
                    </svg>
                    Scatta Foto
                </button>
            </div>
            <div id="cameraViewContainer" style="display:none;">
                <video id="cameraFeed" autoplay playsinline></video>
                <div class="camera-controls">
                    <button id="captureImageButton">Scatta!</button>
                    <button id="switchCameraButton">Cambia</button>
                    <button id="closeCameraButton">Annulla</button>
                </div>
            </div>
            <div id="imagePreviewContainer">
                <img id="imagePreview" src="#" alt="Anteprima Immagine" style="display:none;">
                <canvas id="detectionCanvas" style="display:none;"></canvas>
            </div>
        </div>

        <div id="mainContentArea">
            <div class="options-section" id="durationSection">
                <h3>2. Durata Musica</h3>
                <div class="radio-duration-group">
                    <div class="radio-duration-item">
                        <input type="radio" id="duration40" name="musicDuration" value="40" checked>
                        <label for="duration40"><span class="duration-value">40s</span><span class="duration-credit">2
                                crediti</span></label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration60" name="musicDuration" value="60">
                        <label for="duration60"><span class="duration-value">60s</span><span class="duration-credit">3
                                crediti</span></label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration120" name="musicDuration" value="120">
                        <label for="duration120"><span class="duration-value">120s</span><span class="duration-credit">6
                                crediti</span></label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration180" name="musicDuration" value="180">
                        <label for="duration180"><span class="duration-value">180s</span><span class="duration-credit">9
                                crediti</span></label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration240" name="musicDuration" value="240">
                        <label for="duration240"><span class="duration-value">240s</span><span
                                class="duration-credit">12 crediti</span></label>
                    </div>
                    <div class="radio-duration-item">
                        <input type="radio" id="duration360" name="musicDuration" value="360">
                        <label for="duration360"><span class="duration-value">360s</span><span
                                class="duration-credit">18 crediti</span></label>
                    </div>
                </div>
            </div>

            <div class="action-buttons-container">
                <button id="generateMusicButton" disabled>Avvia generazione musica <span id="musicSpinner"
                        style="display:none;" class="spinner"></span></button>
            </div>

            <div id="dynamicFeedbackArea">
                <div id="status" class="status-message">In attesa del caricamento dei modelli AI...</div>
                <div id="progressAndPlayerContainer">
                    <div id="progressMessage"></div>
                    <div class="progress-bar-container" id="progressBarContainer">
                        <div class="progress-bar-animated" id="progressBarAnimated"></div>
                    </div>
                    <div id="audioPlayerContainer">
                        <h3>Musica Generata</h3>
                        <audio id="audioPlayer" controls src=""></audio>
                        <p id="audioInfo"></p>
                        <div id="downloadButtonsContainer">
                            <a id="downloadAudioLink" href="#" class="download-button" style="display:none;">Scarica
                                Audio</a>
                            <a id="downloadCompositeImageLink" href="#" class="download-button"
                                style="display:none;">Scarica Img+QR</a>
                            <a id="downloadQrOnlyLink" href="#" class="download-button" style="display:none;">Scarica
                                QR</a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="aiInsightsSection" class="options-section">
                <h3>COSA VEDE L'AI</h3>
                <p id="aiInterpretationText">L'intelligenza artificiale ha analizzato la tua immagine per coglierne
                    l'essenza e trasformarla in musica. Ecco come ha interpretato gli elementi visivi:</p>
                <div class="details-accordion-header">
                    <span>Dettagli</span>
                    <span class="toggle-icon"></span>
                </div>
                <div id="aiInsightsContent">
                    <div class="ai-processing-simulation" id="aiProcessingSimulation">
                        <p>In attesa di analisi immagine...</p>
                    </div>
                </div>
            </div>

            <div class="options-section" id="descriptiveCuesSection">
                <h3>FAI LE TUE PERSONALIZZAZIONI <span
                        style="font-weight:normal; font-size:0.8em; color:var(--light-text);">(opzionale)</span></h3>
                <p class="info-text-cues-main">L'IA genererà la musica anche senza selezioni, basandosi sull'immagine.
                    Le tue scelte aiuteranno a guidare l'interpretazione.</p>
                <div class="bpm-slider-container"
                    style="background-color: var(--light-bg); padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <label for="bpmSlider"
                        style="font-weight: 600; color: var(--dark-text); font-size: 1.05em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        🎵 Velocità (BPM): <span id="bpmValue"
                            style="color: var(--primary-color); font-weight: 700;">120</span>
                    </label>
                    <input type="range" id="bpmSlider" name="bpm" min="40" max="200" value="120" step="5"
                        style="width: 100%; cursor: pointer; accent-color: var(--primary-color);">
                </div>
                <div class="cues-grid-container">
                    <div class="cues-column">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="moodPills">
                                <div class="cue-header-content">
                                    <img src="/wp-content/pictosound/icone/mood_icon.jpg" alt="Mood"
                                        class="cue-icon-small"
                                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjY2NjIiBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptLTIgMTVsLTUtNSAxLjQxLTEuNDFMMTAgMTQuMTdsNy41OS03LjU5TDE5IDhsLTkgOXoiLz48L3N2Zz4='; this.onerror=null;">
                                    <span class="cue-title">Mood</span>
                                </div>
                                <span class="toggle-icon-cues"></span>
                            </label>
                            <div class="checkbox-pills-group" id="moodPills"></div>
                        </div>
                    </div>
                    <div class="cues-column">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="genrePills">
                                <div class="cue-header-content">
                                    <img src="/wp-content/pictosound/icone/genere_icon.jpg" alt="Genere"
                                        class="cue-icon-small"
                                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjY2NjIiBkPSJNMTIgM3Y5LjI4Yy0uNDctLjE3LTEtLjI4LTEuNTQtLjI4QzguMDEgMTIgNiAxNC4wMSA2IDE2LjVTOC4wMSAyMSAxMC40NiAyMXMyLjU0LTIuMDEgMi41NC00LjVWN2g0VjNIMTJ6Ii8+PC9zdmc+'; this.onerror=null;">
                                    <span class="cue-title">Genere</span>
                                </div>
                                <span class="toggle-icon-cues"></span>
                            </label>
                            <div class="checkbox-pills-group" id="genrePills"></div>
                        </div>
                    </div>
                    <div class="cues-column">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="instrumentPills">
                                <div class="cue-header-content">
                                    <img src="/wp-content/pictosound/icone/strumenti_icon.jpg" alt="Strumenti"
                                        class="cue-icon-small"
                                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjY2NjIiBkPSJtMTIgM2w0IDR2NGgtM3Y4aC0ydi04SDh2LTRsMTIgMyA0IDR2NGgtM3Y4aC0ydi04SDh2LTRsNC00eiIvPjwvc3ZnPg=='; this.onerror=null;">
                                    <span class="cue-title">Strumenti</span>
                                </div>
                                <span class="toggle-icon-cues"></span>
                            </label>
                            <div class="checkbox-pills-group" id="instrumentPills"></div>
                        </div>
                    </div>
                    <div class="cues-column">
                        <div class="cues-selection-container">
                            <label class="group-label collapsible-cue-header" for="rhythmPills">
                                <div class="cue-header-content">
                                    <img src="/wp-content/pictosound/icone/ritmo_icon.jpg" alt="Ritmo"
                                        class="cue-icon-small"
                                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjY2NjIiBkPSJNOCAzdjJIOXY2aDJWNWgxVjNIOHptNiAwaC0ydjJoMXY2aDJWNWgxVjNoLTJ6bS02IDEwdjJoMXY2aDJWMTVoMXYtMkg4em02IDBoLTJ2MmgxdjZoMlYxNWgxdi0yaC0yeiIvPjwvc3ZnPg=='; this.onerror=null;">
                                    <span class="cue-title">Ritmo</span>
                                </div>
                                <span class="toggle-icon-cues"></span>
                            </label>
                            <div class="checkbox-pills-group" id="rhythmPills"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="imageCanvas" style="display:none;"></canvas>
    <canvas id="compositeImageCanvas" style="display:none;"></canvas>
    <textarea id="additionalCuesTextarea" style="display:none;"></textarea>

    <script src="/wp-content/pictosound/js/tf.min.js"></script>
    <script src="/wp-content/pictosound/js/coco-ssd.min.js"></script>
    <script src="/wp-content/pictosound/js/face-api.min.js"></script>
    <script src="/wp-content/pictosound/js/qrcode.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("LOG: DOMContentLoaded - PictoSound con AI reale inizializzato.");

            // ===================================================================
            // 🎯 CACHE DOM ELEMENTS (COMPLETO)
            // ===================================================================
            const domElements = {
                statusDiv: document.getElementById('status'),
                dynamicFeedbackArea: document.getElementById('dynamicFeedbackArea'),
                progressAndPlayerContainer: document.getElementById('progressAndPlayerContainer'),
                progressMessage: document.getElementById('progressMessage'),
                progressBarContainer: document.getElementById('progressBarContainer'),
                progressBarAnimated: document.getElementById('progressBarAnimated'),
                imageUpload: document.getElementById('imageUpload'),
                takePictureButton: document.getElementById('takePictureButton'),
                cameraViewContainer: document.getElementById('cameraViewContainer'),
                cameraFeed: document.getElementById('cameraFeed'),
                captureImageButton: document.getElementById('captureImageButton'),
                switchCameraButton: document.getElementById('switchCameraButton'),
                closeCameraButton: document.getElementById('closeCameraButton'),
                imageCanvas: document.getElementById('imageCanvas'),
                compositeImageCanvas: document.getElementById('compositeImageCanvas'),
                imagePreview: document.getElementById('imagePreview'),
                detectionCanvas: document.getElementById('detectionCanvas'),
                generateMusicButton: document.getElementById('generateMusicButton'),
                musicSpinner: document.getElementById('musicSpinner'),
                moodPillsContainer: document.getElementById('moodPills'),
                genrePillsContainer: document.getElementById('genrePills'),
                instrumentPillsContainer: document.getElementById('instrumentPills'),
                rhythmPillsContainer: document.getElementById('rhythmPills'),
                bpmSlider: document.getElementById('bpmSlider'),
                bpmValueDisplay: document.getElementById('bpmValue'),
                aiInsightsSection: document.getElementById('aiInsightsSection'),
                aiInterpretationText: document.getElementById('aiInterpretationText'),
                detailsAccordionHeader: document.querySelector('.details-accordion-header'),
                aiInsightsContent: document.getElementById('aiInsightsContent'),
                aiProcessingSimulationDiv: document.getElementById('aiProcessingSimulation'),
                audioPlayerContainer: document.getElementById('audioPlayerContainer'),
                audioPlayer: document.getElementById('audioPlayer'),
                audioInfo: document.getElementById('audioInfo'),
                downloadAudioLink: document.getElementById('downloadAudioLink'),
                downloadCompositeImageLink: document.getElementById('downloadCompositeImageLink'),
                downloadQrOnlyLink: document.getElementById('downloadQrOnlyLink'),
            };

            // ===================================================================
            // 🔧 STATE VARIABLES
            // ===================================================================

            // Immagine e analisi
            let currentImage = null;
            let currentImageSrc = null;
            let imageAnalysisResults = null;
            let stableAudioPromptForMusic = "";
            let initialPreselectionDoneForCurrentImage = false;

            // Camera e mobile
            let currentStream = null;
            let currentFacingMode = "environment";
            let zoomCapabilities = null;
            let currentZoom = 1;
            let initialPinchDistance = 0;
            let lastTap = 0;
            const DOUBLE_TAP_DELAY = 300; // ms

            // AI Models
            let cocoSsdModel = null;
            let faceApiModelsLoaded = false;

            // Contexts
            const imageAnalysisCtx = domElements.imageCanvas ? domElements.imageCanvas.getContext('2d') : null;

            // ===================================================================
            // 📸 FUNZIONI AVANZATE FOTOCAMERA MOBILE
            // ===================================================================

            function applyCameraStyles() {
                if (document.getElementById('pictosound-camera-styles')) return;
                const style = document.createElement('style');
                style.id = 'pictosound-camera-styles';
                style.innerHTML = `
                body.camera-active {
                    overflow: hidden;
                }
                #cameraViewContainer {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: #000;
                    z-index: 1000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                }
                #cameraFeed {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                .camera-controls {
                    position: absolute;
                    bottom: 20px;
                    width: 100%;
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    z-index: 1001;
                }
            `;
                document.head.appendChild(style);
            }

            async function openCamera() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    setStatusMessage("Il tuo browser non supporta l'accesso alla fotocamera.", "error");
                    return;
                }

                applyCameraStyles();
                document.body.classList.add('camera-active');

                if (currentStream) closeCamera();

                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                try {
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    domElements.cameraFeed.srcObject = currentStream;
                    domElements.cameraViewContainer.style.display = 'flex';

                    // Gestione Zoom
                    const [track] = currentStream.getVideoTracks();
                    const capabilities = track.getCapabilities();
                    if (capabilities.zoom) {
                        zoomCapabilities = capabilities.zoom;
                        currentZoom = zoomCapabilities.min;
                        addTouchListeners();
                        console.log("LOG: Zoom supportato. Range:", zoomCapabilities.min, "-", zoomCapabilities.max);
                    } else {
                        console.log("LOG: Zoom non supportato da questa fotocamera.");
                    }

                } catch (error) {
                    handleCameraError(error);
                }
            }

            function handleCameraError(error) {
                console.error("Errore accesso fotocamera:", error);
                let errorMessage = "Impossibile accedere alla fotocamera.";
                if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                    errorMessage = "Hai negato il permesso di usare la fotocamera. Abilitalo nelle impostazioni del browser.";
                } else if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
                    errorMessage = "Nessuna fotocamera trovata sul tuo dispositivo.";
                }
                setStatusMessage(errorMessage, "error");
                closeCamera();
            }

            function closeCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                removeTouchListeners();
                domElements.cameraViewContainer.style.display = 'none';
                document.body.classList.remove('camera-active');
                setStatusMessage("", "info");
            }

            function captureImage() {
                if (!currentStream) return;
                const video = domElements.cameraFeed;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                const imageDataUrl = tempCanvas.toDataURL('image/jpeg');
                processNewImage(imageDataUrl);
                closeCamera();
            }

            function switchCamera() {
                currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
                openCamera();
            }

            function addTouchListeners() {
                domElements.cameraFeed.addEventListener('touchstart', handleTouchStart, { passive: false });
                domElements.cameraFeed.addEventListener('touchmove', handleTouchMove, { passive: false });
                domElements.cameraFeed.addEventListener('touchend', handleTouchEnd);
            }

            function removeTouchListeners() {
                domElements.cameraFeed.removeEventListener('touchstart', handleTouchStart);
                domElements.cameraFeed.removeEventListener('touchmove', handleTouchMove);
                domElements.cameraFeed.removeEventListener('touchend', handleTouchEnd);
            }

            function handleTouchStart(event) {
                event.preventDefault();
                if (event.touches.length === 2) {
                    initialPinchDistance = getDistance(event.touches);
                }
            }

            function handleTouchMove(event) {
                event.preventDefault();
                if (event.touches.length === 2 && zoomCapabilities) {
                    const newDistance = getDistance(event.touches);
                    const zoomFactor = newDistance / initialPinchDistance;

                    let newZoom = currentZoom * zoomFactor;
                    newZoom = Math.max(zoomCapabilities.min, Math.min(newZoom, zoomCapabilities.max));

                    const [track] = currentStream.getVideoTracks();
                    track.applyConstraints({ advanced: [{ zoom: newZoom }] });
                }
            }

            function handleTouchEnd(event) {
                if (event.touches.length > 0) return;

                const currentTime = new Date().getTime();
                const timeSinceLastTap = currentTime - lastTap;

                if (timeSinceLastTap < DOUBLE_TAP_DELAY && timeSinceLastTap > 0) {
                    console.log("LOG: Doppio tocco rilevato, scatto la foto.");
                    captureImage();
                }

                lastTap = currentTime;
                initialPinchDistance = 0;

                if (zoomCapabilities) {
                    const [track] = currentStream.getVideoTracks();
                    currentZoom = track.getSettings().zoom || 1;
                }
            }

            function getDistance(touches) {
                const [touch1, touch2] = touches;
                return Math.sqrt(
                    Math.pow(touch2.pageX - touch1.pageX, 2) +
                    Math.pow(touch2.pageY - touch1.pageY, 2)
                );
            }

            // ===================================================================
            // 🧠 FUNZIONI REALI DI ANALISI AI
            // ===================================================================

            async function loadModels() {
                try {
                    setStatusMessage("🤖 Caricamento modelli AI in corso...", "info");

                    console.log("🔄 Caricamento COCO-SSD...");
                    cocoSsdModel = await cocoSsd.load();
                    console.log("✅ COCO-SSD caricato con successo");

                    console.log("🔄 Caricamento Face-API models...");
                    const baseUrl = '/wp-content/pictosound/js/models';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(baseUrl),
                        faceapi.nets.faceExpressionNet.loadFromUri(baseUrl),
                        faceapi.nets.ageGenderNet.loadFromUri(baseUrl)
                    ]);
                    faceApiModelsLoaded = true;
                    console.log("✅ Face-API models caricati con successo");

                    setStatusMessage("🎉 Modelli AI pronti! Carica un'immagine per iniziare.", "success");

                } catch (error) {
                    console.error("❌ Errore nel caricamento dei modelli:", error);
                    setStatusMessage("⚠️ Alcuni modelli AI non sono disponibili. L'analisi potrebbe essere limitata.", "error");
                }
            }

            function setStatusMessage(message, type = "info") {
                if (!domElements.statusDiv) return;
                domElements.statusDiv.textContent = message;
                domElements.statusDiv.className = 'status-message';
                if (type === "error") domElements.statusDiv.classList.add("status-error");
                else if (type === "success") domElements.statusDiv.classList.add("status-success");
                domElements.statusDiv.style.display = message ? 'block' : 'none';
            }

            function analyzeImageAdvanced(imageElement) {
                console.log("🎨 ANALISI COLORI REALE in corso...");

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const maxSize = 300;
                const scale = Math.min(maxSize / imageElement.width, maxSize / imageElement.height);
                canvas.width = imageElement.width * scale;
                canvas.height = imageElement.height * scale;

                ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;

                const colorCounts = {};
                let totalBrightness = 0;
                let totalSaturation = 0;
                let pixelCount = 0;

                for (let i = 0; i < pixels.length; i += 4) {
                    const r = pixels[i];
                    const g = pixels[i + 1];
                    const b = pixels[i + 2];
                    const a = pixels[i + 3];

                    if (a < 128) continue;

                    const brightness = (r * 0.299 + g * 0.587 + b * 0.114);
                    totalBrightness += brightness;

                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    const saturation = max === 0 ? 0 : (max - min) / max * 100;
                    totalSaturation += saturation;

                    const colorKey = `${Math.floor(r / 20) * 20},${Math.floor(g / 20) * 20},${Math.floor(b / 20) * 20}`;
                    colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;

                    pixelCount++;
                }

                const sortedColors = Object.entries(colorCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                const dominantColors = sortedColors.map(([colorKey, count]) => {
                    const [r, g, b] = colorKey.split(',').map(Number);
                    const percentage = Math.round((count / pixelCount) * 100);

                    const max = Math.max(r, g, b) / 255;
                    const min = Math.min(r, g, b) / 255;
                    const lightness = (max + min) / 2;
                    const delta = max - min;
                    const saturation = delta === 0 ? 0 : delta / (1 - Math.abs(2 * lightness - 1));

                    let hue = 0;
                    if (delta !== 0) {
                        if (max === r / 255) hue = ((g / 255 - b / 255) / delta) % 6;
                        else if (max === g / 255) hue = (b / 255 - r / 255) / delta + 2;
                        else hue = (r / 255 - g / 255) / delta + 4;
                    }
                    hue = Math.round(hue * 60);
                    if (hue < 0) hue += 360;

                    return {
                        r, g, b,
                        percentage,
                        hue: hue,
                        saturation: Math.round(saturation * 100),
                        lightness: Math.round(lightness * 100)
                    };
                });

                const averageBrightness = Math.round(totalBrightness / pixelCount);
                const averageSaturation = Math.round(totalSaturation / pixelCount);

                const maxBrightness = Math.max(...dominantColors.map(c => c.lightness));
                const minBrightness = Math.min(...dominantColors.map(c => c.lightness));
                const contrast = maxBrightness - minBrightness;

                const result = {
                    dominantColors,
                    averageBrightness,
                    contrast,
                    averageSaturation
                };

                console.log("✅ ANALISI COLORI REALE completata:", result);
                return result;
            }

            async function detectObjectsInImage(imageElement) {
                if (!cocoSsdModel) {
                    console.warn("⚠️ Modello COCO-SSD non ancora caricato");
                    return ["oggetto_generico"];
                }

                try {
                    console.log("🔍 OBJECT DETECTION REALE in corso...");
                    const predictions = await cocoSsdModel.detect(imageElement);
                    const detectedObjects = predictions
                        .filter(prediction => prediction.score > 0.3)
                        .map(prediction => prediction.class)
                        .filter((value, index, self) => self.indexOf(value) === index);

                    console.log("✅ OGGETTI REALI rilevati:", detectedObjects);
                    return detectedObjects.length > 0 ? detectedObjects : ["scena_generica"];
                } catch (error) {
                    console.error("❌ Errore nel rilevamento oggetti:", error);
                    return ["oggetto_generico"];
                }
            }

            async function analyzeFacesInImage(imageElement) {
                if (!faceApiModelsLoaded) {
                    console.warn("⚠️ Modelli Face-API non ancora caricati");
                    return ["neutral"];
                }

                try {
                    console.log("😊 EMOTION DETECTION REALE in corso...");
                    const detections = await faceapi
                        .detectAllFaces(imageElement, new faceapi.TinyFaceDetectorOptions())
                        .withFaceExpressions();

                    if (detections.length === 0) {
                        console.log("ℹ️ Nessun volto rilevato");
                        return ["no_face"];
                    }

                    const emotions = detections.map(detection => {
                        const expressions = detection.expressions;
                        let maxExpression = 'neutral';
                        let maxScore = 0;
                        Object.entries(expressions).forEach(([emotion, score]) => {
                            if (score > maxScore && score > 0.3) {
                                maxScore = score;
                                maxExpression = emotion;
                            }
                        });
                        return maxExpression;
                    });

                    console.log("✅ EMOZIONI REALI rilevate:", emotions);
                    return [...new Set(emotions)];
                } catch (error) {
                    console.error("❌ Errore nell'analisi delle espressioni:", error);
                    return ["neutral"];
                }
            }

            // ===================================================================
            // 🎵 LOGICA MUSICALE
            // ===================================================================

            const moodItems = [
                { value: "felice", label: "Felice / Gioioso" }, { value: "triste", label: "Triste / Malinconico" }, { value: "riflessivo", label: "Riflessivo" },
                { value: "epico", label: "Epico / Grandioso" }, { value: "rilassante", label: "Rilassante / Calmo" },
                { value: "energico", label: "Energico / Vivace" }, { value: "misterioso", label: "Misterioso / Inquietante" },
                { value: "sognante", label: "Sognante / Etereo" }, { value: "romantico", label: "Romantico" },
                { value: "drammatico", label: "Drammatico" }, { value: "futuristico", label: "Futuristico / Sci-Fi" },
                { value: "nostalgico", label: "Nostalgico" }, { value: "potente", label: "Potente / Intenso" },
                { value: "meravigliato", label: "Meravigliato" }, { value: "anticipatorio", label: "Anticipatorio" }, { value: "sospeso", label: "Sospeso" }
            ];
            const genreItems = [
                { value: "elettronica", label: "Elettronica" }, { value: "dance", label: "Dance / EDM" },
                { value: "rock", label: "Rock" }, { value: "pop", label: "Pop" }, { value: "jazz", label: "Jazz" },
                { value: "classica", label: "Classica" }, { value: "ambient", label: "Ambient" },
                { value: "soundtrack", label: "Soundtrack / Cinematografica" }, { value: "folk", label: "Folk / Acustica" }, { value: "folk acustico", label: "Folk Acustico" }, { value: "ambient naturale", label: "Ambient Naturale" },
                { value: "lo-fi", label: "Lo-fi / Chillhop" }, { value: "hip-hop", label: "Hip Hop" }, { value: "lo-fi hip hop", label: "Lo-fi Hip Hop" },
                { value: "funk", label: "Funk / Soul" }, { value: "metal", label: "Metal" },
                { value: "reggae", label: "Reggae" }, { value: "blues", label: "Blues" },
                { value: "world", label: "World Music / Etnica" }, { value: "urban jazz", label: "Urban Jazz" }
            ];
            const instrumentItems = [
                { value: "pianoforte", label: "Pianoforte" }, { value: "chitarra acustica", label: "Chitarra Acustica" },
                { value: "chitarra elettrica", label: "Chitarra Elettrica" }, { value: "basso", label: "Basso" }, { value: "basso profondo", label: "Basso Profondo" },
                { value: "batteria", label: "Batteria / Percussioni" }, { value: "violino", label: "Violino / Archi" }, { value: "archi lenti", label: "Archi Lenti" },
                { value: "violoncello", label: "Violoncello" }, { value: "sassofono", label: "Sassofono" }, { value: "sassofono contralto", label: "Sassofono Contralto" },
                { value: "tromba", label: "Tromba / Ottoni" }, { value: "flauto", label: "Flauto" }, { value: "flauto brillante", label: "Flauto Brillante" }, { value: "clarinetto", label: "Clarinetto" },
                { value: "sintetizzatore", label: "Sintetizzatore / Tastiere" }, { value: "sintetizzatore lead malinconico", label: "Synth Lead Malinconico" },
                { value: "organo", label: "Organo" }, { value: "arpa", label: "Arpa" }, { value: "ukulele", label: "Ukulele" },
                { value: "voce umana (cori o effetti)", label: "Voce umana (cori o effetti)" }, { value: "voce solista", label: "Voce Solista" },
                { value: "glockenspiel", label: "Glockenspiel" }, { value: "pad eterei", label: "Pad Eterei" },
                { value: "chitarra con riverbero", label: "Chitarra con Riverbero" }, { value: "chitarra elettrica con overdrive leggero", label: "Chitarra Elettrica Overdrive Leggero" },
                { value: "nessuno strumento specifico", label: "Nessuno strumento specifico" }
            ];
            const rhythmItems = [
                { value: "no_rhythm", label: "Nessun ritmo evidente (Ambientale)" },
                { value: "slow_rhythm", label: "Ritmo Lento e Rilassato" },
                { value: "moderate_groove", label: "Groove Moderato e Orecchiabile" },
                { value: "upbeat_energetic", label: "Ritmo Incalzante ed Energico" },
                { value: "complex_experimental_rhythm", label: "Ritmo Complesso / Sperimentale" }
            ];

            function populateCheckboxPills(container, items, groupName) {
                if (!container) return;
                container.innerHTML = '';
                items.forEach(item => {
                    const pillLabel = document.createElement('label');
                    pillLabel.classList.add('checkbox-pill');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = groupName;
                    checkbox.value = item.value;
                    checkbox.addEventListener('change', function () {
                        pillLabel.classList.toggle('selected', this.checked);
                        initialPreselectionDoneForCurrentImage = true;
                        if (currentImage && imageAnalysisResults) {
                            updateAIDisplayAndStablePrompt();
                        }
                    });
                    pillLabel.appendChild(checkbox);
                    pillLabel.appendChild(document.createTextNode(item.label));
                    container.appendChild(pillLabel);
                });
            }

            function setupCollapsibleSections() {
                if (domElements.detailsAccordionHeader) {
                    domElements.detailsAccordionHeader.addEventListener('click', () => {
                        const isOpen = domElements.detailsAccordionHeader.classList.toggle('open');
                        domElements.aiInsightsContent.style.display = isOpen ? 'block' : 'none';
                    });
                }
                document.querySelectorAll('.collapsible-cue-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('open');
                        const pillsGroup = header.nextElementSibling;
                        if (pillsGroup && pillsGroup.classList.contains('checkbox-pills-group')) {
                            pillsGroup.classList.toggle('open');
                        }
                    });
                });
            }

            function getSelectedCheckboxValues(groupName) {
                return Array.from(document.querySelectorAll(`input[name="${groupName}"]:checked`)).map(cb => cb.value);
            }

            function getMusicalCues(analysis, userInputs) {
                const { colors, objects, emotions } = analysis;
                const cues = {
                    moods: [...userInputs.selectedMoods],
                    genres: [...userInputs.selectedGenres],
                    instruments: [...userInputs.selectedInstruments],
                    rhythms: [...userInputs.selectedRhythms],
                    tempoBPM: userInputs.selectedBPM
                };

                if (userInputs.selectedMoods.length === 0) {
                    if (emotions.includes("happy")) cues.moods.push("felice", "energico");
                    if (emotions.includes("sad")) cues.moods.push("triste", "malinconico");
                    if (emotions.includes("angry")) cues.moods.push("potente", "intenso");
                    if (emotions.includes("surprised")) cues.moods.push("meravigliato");
                    if (emotions.includes("fearful")) cues.moods.push("misterioso", "drammatico");
                    if (emotions.includes("neutral") || emotions.includes("no_face")) {
                        if (colors && colors.averageBrightness > 180) cues.moods.push("felice", "energico");
                        if (colors && colors.averageBrightness < 70) cues.moods.push("misterioso", "drammatico");
                        if (colors && colors.averageSaturation > 70) cues.moods.push("energico");
                        if (colors && colors.averageSaturation < 30) cues.moods.push("rilassante", "riflessivo");
                    }
                }

                if (userInputs.selectedGenres.length === 0) {
                    if (objects.some(obj => ['bird', 'tree', 'grass', 'mountain', 'sky'].includes(obj))) cues.genres.push("ambient", "folk", "soundtrack");
                    if (objects.includes("person")) {
                        if (emotions.includes("happy")) cues.genres.push("pop", "dance");
                        else cues.genres.push("folk", "jazz");
                    }
                    if (objects.some(obj => ['car', 'bus', 'motorbike'].includes(obj))) cues.genres.push("rock", "elettronica");
                    if (objects.some(obj => ['bottle', 'wine glass', 'cake'].includes(obj))) cues.genres.push("jazz");
                }

                if (userInputs.selectedInstruments.length === 0) {
                    if (cues.moods.some(m => ['triste', 'malinconico', 'riflessivo'].includes(m))) cues.instruments.push("pianoforte", "violoncello", "archi lenti");
                    if (cues.moods.some(m => ['felice', 'energico'].includes(m))) cues.instruments.push("chitarra elettrica", "batteria", "sintetizzatore");
                    if (cues.genres.includes("jazz")) cues.instruments.push("sassofono", "pianoforte", "basso");
                    if (cues.genres.includes("folk")) cues.instruments.push("chitarra acustica", "violino");
                }

                for (const key in cues) {
                    if (Array.isArray(cues[key])) {
                        cues[key] = [...new Set(cues[key])];
                    }
                }
                return cues;
            }

            function preselectCuesFromAnalysis(musicalCues) {
                if (!musicalCues) return;
                const preselectGroup = (items, cueValues, groupName) => {
                    const container = domElements[groupName + 'PillsContainer'];
                    if (!container) return;
                    let hasSelection = false;
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        const pillLabel = checkbox.closest('.checkbox-pill');
                        const shouldBeChecked = cueValues.map(cv => cv.toLowerCase()).includes(checkbox.value.toLowerCase());
                        checkbox.checked = shouldBeChecked;
                        pillLabel.classList.toggle('selected', shouldBeChecked);
                        if (shouldBeChecked) hasSelection = true;
                    });
                    const header = container.previousElementSibling;
                    if (hasSelection && header && header.classList.contains('collapsible-cue-header') && !header.classList.contains('open')) {
                        header.click();
                    }
                };
                preselectGroup(moodItems, musicalCues.moods || [], 'mood');
                preselectGroup(genreItems, musicalCues.genres || [], 'genre');
                preselectGroup(instrumentItems, musicalCues.instruments || [], 'instrument');
                preselectGroup(rhythmItems, musicalCues.rhythms || [], 'rhythm');
            }

            function generateStableAudioPrompt(cues) {
                const parts = [];
                if (cues.moods.length > 0) parts.push(...cues.moods);
                if (cues.genres.length > 0) parts.push(...cues.genres);
                if (cues.instruments.length > 0) parts.push(...cues.instruments);
                if (cues.rhythms.length > 0) parts.push(...cues.rhythms);
                parts.push(`${cues.tempoBPM} BPM`);
                return [...new Set(parts)].join(', ') + ", high quality audio";
            }

            function generateAIDisplayContent(analysis, finalPrompt) {
                const { colors, objects, emotions } = analysis;
                const existingDetails = domElements.aiInsightsContent.querySelectorAll('h4, ul, #finalPromptForAI');
                existingDetails.forEach(el => el.remove());
                let html = "<h4>🔍 Analisi Immagine Reale:</h4><ul>";
                html += `<li><strong>Oggetti rilevati:</strong> ${objects.join(', ')}</li>`;
                html += `<li><strong>Emozioni facciali:</strong> ${emotions.join(', ')}</li>`;
                if (colors && colors.dominantColors && colors.dominantColors.length > 0) {
                    html += "<li><strong>Colori dominanti:</strong><ul>";
                    colors.dominantColors.forEach(c => {
                        html += `<li><span class="color-swatch-inline" style="background-color: rgb(${c.r},${c.g},${c.b});"></span>rgb(${c.r},${c.g},${c.b}) - ${c.percentage}%</li>`;
                    });
                    html += "</ul></li>";
                    html += `<li><strong>Luminosità media:</strong> ${colors.averageBrightness}/255</li>`;
                    html += `<li><strong>Saturazione media:</strong> ${colors.averageSaturation}%</li>`;
                    html += `<li><strong>Contrasto:</strong> ${colors.contrast}%</li>`;
                }
                html += "</ul>";
                html += `<div id="finalPromptForAI"><strong>🎵 Prompt Musicale Finale:</strong><br>${finalPrompt}</div>`;
                domElements.aiInsightsContent.insertAdjacentHTML('beforeend', html);
            }

            async function updateAIDisplayAndStablePrompt() {
                if (!currentImage) return;

                if (!imageAnalysisResults) {
                    domElements.aiProcessingSimulationDiv.style.display = 'block';
                    domElements.aiProcessingSimulationDiv.innerHTML = '<p>🧠 Analisi AI REALE in corso...</p>';
                    try {
                        imageAnalysisResults = {
                            colors: analyzeImageAdvanced(currentImage),
                            objects: await detectObjectsInImage(currentImage),
                            emotions: await analyzeFacesInImage(currentImage)
                        };
                        console.log("🎯 Analisi REALE completata:", imageAnalysisResults);
                    } catch (error) {
                        console.error("❌ Errore durante l'analisi:", error);
                        imageAnalysisResults = {
                            colors: { dominantColors: [], averageBrightness: 128, contrast: 50, averageSaturation: 50 },
                            objects: ["oggetto_generico"],
                            emotions: ["neutral"]
                        };
                    }
                    domElements.aiProcessingSimulationDiv.style.display = 'none';
                    initialPreselectionDoneForCurrentImage = false;
                }

                const userInputs = {
                    selectedMoods: getSelectedCheckboxValues('mood'),
                    selectedGenres: getSelectedCheckboxValues('genre'),
                    selectedInstruments: getSelectedCheckboxValues('instrument'),
                    selectedRhythms: getSelectedCheckboxValues('rhythm'),
                    selectedBPM: domElements.bpmSlider.value,
                };

                const musicalCues = getMusicalCues(imageAnalysisResults, userInputs);

                if (!initialPreselectionDoneForCurrentImage) {
                    preselectCuesFromAnalysis(musicalCues);
                }

                const finalCues = {
                    moods: getSelectedCheckboxValues('mood'),
                    genres: getSelectedCheckboxValues('genre'),
                    instruments: getSelectedCheckboxValues('instrument'),
                    rhythms: getSelectedCheckboxValues('rhythm'),
                    tempoBPM: domElements.bpmSlider.value,
                };
                stableAudioPromptForMusic = generateStableAudioPrompt(finalCues);

                generateAIDisplayContent(imageAnalysisResults, stableAudioPromptForMusic);
                domElements.aiInsightsSection.style.display = 'block';
                domElements.generateMusicButton.disabled = false;
            }

            async function processNewImage(imageSrc) {
                currentImageSrc = imageSrc;
                domElements.imagePreview.src = imageSrc;
                domElements.imagePreview.style.display = 'block';
                currentImage = new Image();
                currentImage.onload = async () => {
                    imageAnalysisResults = null;
                    initialPreselectionDoneForCurrentImage = false;
                    document.querySelectorAll('.checkbox-pill.selected').forEach(pill => pill.classList.remove('selected'));
                    document.querySelectorAll('.checkbox-pills-group input').forEach(cb => cb.checked = false);
                    document.querySelectorAll('.collapsible-cue-header.open').forEach(header => header.classList.remove('open'));
                    document.querySelectorAll('.checkbox-pills-group.open').forEach(group => group.classList.remove('open'));
                    setStatusMessage("🎨 Immagine caricata! Analisi AI REALE in corso...", "info");
                    await updateAIDisplayAndStablePrompt();
                    setStatusMessage("✅ Analisi REALE completata! Ora puoi generare la musica.", "success");
                };
                currentImage.src = imageSrc;
            }

            // ===================================================================
            // 🔌 COLLEGAMENTO EVENTI
            // ===================================================================

            if (domElements.takePictureButton) domElements.takePictureButton.addEventListener('click', openCamera);
            if (domElements.closeCameraButton) domElements.closeCameraButton.addEventListener('click', closeCamera);
            if (domElements.captureImageButton) domElements.captureImageButton.addEventListener('click', captureImage);
            if (domElements.switchCameraButton) domElements.switchCameraButton.addEventListener('click', switchCamera);

            domElements.imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => processNewImage(e.target.result);
                    reader.readAsDataURL(file);
                }
            });

            // GESTORE CLICK PER LA GENERAZIONE MUSICALE - UNICO E CORRETTO
            domElements.generateMusicButton.addEventListener('click', async () => {
                console.log("🎵 Avvio generazione musica con prompt:", stableAudioPromptForMusic);

                if (!stableAudioPromptForMusic || !currentImage) {
                    setStatusMessage("⚠️ Prima devi caricare e analizzare un'immagine!", "error");
                    return;
                }

                // Ottieni la durata selezionata
                const selectedDurationInput = document.querySelector('input[name="musicDuration"]:checked');
                const selectedDuration = selectedDurationInput ? selectedDurationInput.value : '40';

                // Disabilita il bottone e mostra lo spinner
                domElements.generateMusicButton.disabled = true;
                const originalButtonText = "Avvia generazione musica";
                domElements.generateMusicButton.innerHTML = `Generazione in corso... <span class="spinner" id="musicSpinner" style="display:inline-block;"></span>`;

                // Mostra la barra di progresso
                domElements.progressAndPlayerContainer.style.display = 'block';
                domElements.audioPlayerContainer.style.display = 'none';
                domElements.progressMessage.textContent = 'Richiesta inviata al server...';
                domElements.progressBarContainer.style.display = 'block';
                domElements.progressBarAnimated.style.width = '25%';

                try {
                    // Prepara i dati per l'invio (assumendo che il backend li gestisca, come da codice precedente)
                    const formData = new FormData();
                    formData.append('action', 'pictosound_generate_music');
                    if (typeof pictosound_vars !== 'undefined') {
                        formData.append('nonce', pictosound_vars.nonce_generate);
                    }
                    formData.append('prompt', stableAudioPromptForMusic);
                    formData.append('duration', selectedDuration);

                    const imageResponse = await fetch(currentImageSrc);
                    const imageBlob = await imageResponse.blob();
                    formData.append('image_file', imageBlob, 'image.jpg');

                    // Chiamata AJAX
                    const fetchResponse = await fetch(pictosound_vars.ajax_url, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await fetchResponse.json();
                    domElements.progressBarAnimated.style.width = '100%';

                    if (result.success) {
                        domElements.progressMessage.textContent = '✅ Musica generata con successo!';
                        domElements.audioPlayerContainer.style.display = 'block';
                        domElements.audioPlayer.src = result.data.audioUrl;
                        domElements.audioInfo.textContent = `Durata: ${selectedDuration}s - File: ${result.data.fileName}`;
                        domElements.downloadAudioLink.href = result.data.downloadUrl;
                        domElements.downloadAudioLink.style.display = 'inline-flex';
                        setStatusMessage("🎵 Musica generata! Puoi ascoltarla e scaricarla.", "success");
                    } else {
                        const errorMsg = result.data?.message || 'Errore sconosciuto durante la generazione';
                        setStatusMessage(`❌ ${errorMsg}`, "error");
                        domElements.progressMessage.textContent = `❌ Errore: ${errorMsg}`;
                    }

                } catch (error) {
                    console.error('Errore grave nella chiamata AJAX:', error);
                    setStatusMessage("❌ Errore di connessione o script. Controlla la console del browser per dettagli (F12).", "error");
                    domElements.progressMessage.textContent = '❌ Errore di connessione o script.';
                } finally {
                    // Ripristina il bottone
                    domElements.generateMusicButton.disabled = false;
                    domElements.generateMusicButton.innerHTML = originalButtonText;
                    domElements.progressBarContainer.style.display = 'none';
                    domElements.progressBarAnimated.style.width = '0%';
                }
            });

            // ===================================================================
            // 🚀 INIZIALIZZAZIONE
            // ===================================================================

            populateCheckboxPills(domElements.moodPillsContainer, moodItems, 'mood');
            populateCheckboxPills(domElements.genrePillsContainer, genreItems, 'genre');
            populateCheckboxPills(domElements.instrumentPillsContainer, instrumentItems, 'instrument');
            populateCheckboxPills(domElements.rhythmPillsContainer, rhythmItems, 'rhythm');
            setupCollapsibleSections();

            domElements.bpmSlider.addEventListener('input', () => {
                domElements.bpmValueDisplay.textContent = domElements.bpmSlider.value;
                if (currentImage) {
                    // Non serve rieseguire tutta l'analisi, solo aggiornare il prompt
                    const finalCues = {
                        moods: getSelectedCheckboxValues('mood'),
                        genres: getSelectedCheckboxValues('genre'),
                        instruments: getSelectedCheckboxValues('instrument'),
                        rhythms: getSelectedCheckboxValues('rhythm'),
                        tempoBPM: domElements.bpmSlider.value,
                    };
                    stableAudioPromptForMusic = generateStableAudioPrompt(finalCues);
                    const finalPromptDiv = document.getElementById('finalPromptForAI');
                    if (finalPromptDiv) {
                        finalPromptDiv.innerHTML = `<strong>🎵 Prompt Musicale Finale:</strong><br>${stableAudioPromptForMusic}`;
                    }
                }
            });

            await loadModels();

            console.log("🎉 PictoSound completamente inizializzato con AI REALE!");
        });
    </script>
</body>

</html>
```